<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Bài kiểm tra Ngữ pháp - Unit 1 & 2 (Hướng dẫn chi tiết)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Montserrat', sans-serif;
        }
        .reason-input {
            margin-top: 4px;
            width: 100%;
            padding: 6px;
            border: 1px solid #d1d5db;
            border-radius: 4px;
            font-style: italic;
            background-color: #f9fafb;
        }
        .example-item {
            background-color: #eff6ff; 
            padding: 12px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            margin-bottom: 16px;
        }
        .teacher-mode .student-answer-container {
            border: 1px solid #16a34a;
            background-color: #f0fdf4;
            color: #15803d;
            padding: 2px 6px;
            border-radius: 4px;
            font-weight: 600;
        }
        .teacher-mode .reason-input {
            border-color: #a7f3d0;
            background-color: #f0fdf4;
            color: #065f46;
        }
    </style>
</head>
<body class="bg-gray-100">

    <div class="container mx-auto p-4 sm:p-8">
        <header class="text-center mb-10">
            <h1 class="text-5xl font-bold text-gray-800">Bài kiểm tra Ngữ pháp</h1>
            <p class="text-2xl text-gray-600 mt-4">Unit 1 & 2 (Hướng dẫn chi tiết)</p>
        </header>

        <div class="space-y-12">
            <div class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Thông tin học sinh</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div>
                        <label for="student-name" class="block text-sm font-medium text-gray-700">Họ và tên</label>
                        <input type="text" id="student-name" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                    <div>
                        <label for="student-class" class="block text-sm font-medium text-gray-700">Lớp</label>
                        <input type="text" id="student-class" class="mt-1 block w-full px-3 py-2 bg-white border border-gray-300 rounded-md shadow-sm focus:outline-none focus:ring-indigo-500 focus:border-indigo-500 sm:text-sm">
                    </div>
                </div>
            </div>

            <section id="part1" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-blue-600 mb-6">Phần 1: Thì Hiện tại & Từ vựng</h2>
                <div id="part1-container" class="space-y-8"></div>
                <div class="mt-6 text-right">
                    <span class="student-feedback font-bold mr-4"></span>
                    <button class="check-btn bg-blue-500 text-white py-2 px-4 rounded-md hover:bg-blue-600">Kiểm tra Phần 1</button>
                </div>
            </section>

            <section id="part2" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-green-600 mb-6">Phần 2: Động từ & Từ vựng</h2>
                <div id="part2-container" class="space-y-8"></div>
                <div class="mt-6 text-right">
                    <span class="student-feedback font-bold mr-4"></span>
                    <button class="check-btn bg-green-500 text-white py-2 px-4 rounded-md hover:bg-green-600">Kiểm tra Phần 2</button>
                </div>
            </section>

            <section id="part3" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-purple-600 mb-6">Phần 3: Giới từ & Từ vựng</h2>
                <div id="part3-container" class="space-y-8"></div>
                <div class="mt-6 text-right">
                    <span class="student-feedback font-bold mr-4"></span>
                    <button class="check-btn bg-purple-500 text-white py-2 px-4 rounded-md hover:bg-purple-600">Kiểm tra Phần 3</button>
                </div>
            </section>

            <section id="part4" class="bg-white p-6 rounded-lg shadow-md">
                <h2 class="text-3xl font-bold text-orange-500 mb-6">Phần 4: There is / are & Từ vựng</h2>
                <div id="part4-container" class="space-y-8"></div>
                <div class="mt-6 text-right">
                    <span class="student-feedback font-bold mr-4"></span>
                    <button class="check-btn bg-orange-500 text-white py-2 px-4 rounded-md hover:bg-orange-600">Kiểm tra Phần 4</button>
                </div>
            </section>

            <div class="text-center mt-10">
                <button id="submit-all-btn" class="bg-red-600 text-white font-bold py-4 px-8 rounded-lg text-2xl hover:bg-red-700 transition-transform transform hover:scale-105">NỘP TOÀN BỘ BÀI</button>
                <p id="submission-status" class="mt-4 text-lg"></p>
            </div>
        </div>
    </div>

    <script>
        // --- DATA --- //
        const exercises = {
            part1: [
                {
                    instruction: "Chọn dạng đúng của động từ và từ vựng cho sẵn.",
                    example: {
                        q: 'My new <span class="student-answer-container">classmate</span> often <span class="student-answer-container">shares</span> his lunch with me.',
                        reason: "Dùng thì hiện tại đơn (shares) vì có \'often\' chỉ thói quen. \'classmate\' là danh từ phù hợp."
                    },
                    questions: [
                        { q: 'Listen! Someone <select class="p-1 rounded border-gray-300 student-answer" data-answer="is knocking"><option></option><option value="knocks">knocks</option><option value="is knocking">is knocking</option></select> on the door.', reason: "Dùng HTTD (is knocking) vì có dấu hiệu \'Listen!\' chỉ hành động đang diễn ra." },
                        { q: 'I <select class="p-1 rounded border-gray-300 student-answer" data-answer="am feeling"><option></option><option value="feel">feel</option><option value="am feeling">am feeling</option></select> very <select class="p-1 rounded border-gray-300 student-answer" data-answer="excited"><option></option><option value="excited">excited</option><option value="creative">creative</option></select> about the first day at my <select class="p-1 rounded border-gray-300 student-answer" data-answer="international"><option></option><option value="international">international</option><option value="boarding school">boarding school</option></select> school.', reason: "Dùng HTTD để diễn tả cảm xúc tạm thời. \'excited\' (phấn khích) và \'international\' (quốc tế) là từ vựng phù hợp." },
                        { q: 'We <select class="p-1 rounded border-gray-300 student-answer" data-answer="are learning"><option></option><option value="learn">learn</option><option value="are learning">are learning</option></select> how to write a <select class="p-1 rounded border-gray-300 student-answer" data-answer="poem"><option></option><option value="poem">poem</option><option value="judo">judo</option></select> in Literature class right now.', reason: "Dùng HTTD (are learning) vì có \'right now\'. \'Poem\' (bài thơ) là từ phù hợp với môn Văn." },
                        { q: 'My brother <select class="p-1 rounded border-gray-300 student-answer" data-answer="is helping"><option></option><option value="helps">helps</option><option value="is helping">is helping</option></select> me with my homework in the <select class="p-1 rounded border-gray-300 student-answer" data-answer="living room"><option></option><option value="living room">living room</option><option value="greenhouse">greenhouse</option></select>.', reason: "HTTD (is helping) diễn tả hành động đang xảy ra. \'Living room\' (phòng khách) là nơi hợp lý." },
                        { q: 'She is very <select class="p-1 rounded border-gray-300 student-answer" data-answer="creative"><option></option><option value="creative">creative</option><option value="smart">smart</option></select>; she always <select class="p-1 rounded border-gray-300 student-answer" data-answer="has"><option></option><option value="has">has</option><option value="is having">is having</option></select> new ideas for the <select class="p-1 rounded border-gray-300 student-answer" data-answer="art"><option></option><option value="art">art</option><option value="activity">activity</option></select> club.', reason: "Dùng HTĐ (has) vì có \'always\'. \'Creative\' (sáng tạo) và \'art\' (nghệ thuật) là các từ liên quan." },
                        { q: 'They usually <select class="p-1 rounded border-gray-300 student-answer" data-answer="remember"><option></option><option value="remember">remember</option><option value="are remembering">are remembering</option></select> to bring their <select class="p-1 rounded border-gray-300 student-answer" data-answer="compass"><option></option><option value="compass">compass</option><option value="pocket money">pocket money</option></select> for the Geography lesson.', reason: "Dùng HTĐ (remember) vì có \'usually\'. \'Compass\' (compa) cần cho môn Địa lý." },
                        { q: 'What <select class="p-1 rounded border-gray-300 student-answer" data-answer="are you doing"><option></option><option value="do you do">do you do</option><option value="are you doing">are you doing</option></select>? I\'m looking for my <select class="p-1 rounded border-gray-300 student-answer" data-answer="equipment"><option></option><option value="equipment">equipment</option><option value="interview">interview</option></select>.', reason: "Câu trả lời ở HTTD (I\'m looking for) nên câu hỏi cũng ở HTTD. \'Equipment\' (thiết bị) là từ phù hợp." },
                        { q: 'He looks <select class="p-1 rounded border-gray-300 student-answer" data-answer="smart"><option></option><option value="smart">smart</option><option value="messy">messy</option></select> in his new school uniform.', reason: "\'Look\' là động từ chỉ tri giác, đi với tính từ. \'Smart\' (bảnh bao) phù hợp với đồng phục mới." },
                    ]
                }
            ],
            part2: [
                {
                    instruction: "Điền động từ đúng (do, play, have, study, help, share, remember) và chọn từ vựng phù hợp.",
                    example: { q: 'We often <span class="student-answer-container">play</span> badminton after school.', reason: "Dùng \'play\' với môn thể thao badminton." },
                    questions: [
                        { q: 'Can you <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="help"> me fix the <select class="p-1 rounded border-gray-300 student-answer" data-answer="air-conditioner"><option></option><option value="air-conditioner">air-conditioner</option><option value="fridge">fridge</option></select>?', reason: "Cấu trúc \'help someone do something\'. \'Air-conditioner\' là một thiết bị trong nhà." },
                        { q: 'My new school <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="has"> a large <select class="p-1 rounded border-gray-300 student-answer" data-answer="swimming pool"><option></option><option value="swimming pool">swimming pool</option><option value="greenhouse">greenhouse</option></select>.', reason: "Dùng \'has\' để chỉ sự sở hữu. \'Swimming pool\' là một địa điểm ở trường." },
                        { q: 'I must <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="do"> my homework before watching TV.', reason: "Cụm từ cố định: \'do homework\' (làm bài tập về nhà)." },
                        { q: 'Do you <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="remember"> your first day at school?', reason: "Dùng \'remember\' (nhớ) để hỏi về kỷ niệm." },
                        { q: 'Let\'s <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="study"> the new vocabulary for the next lesson.', reason: "Dùng \'study\' (học) với các chủ đề như vocabulary." },
                        { q: 'My best friend and I <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="share"> everything, even our <select class="p-1 rounded border-gray-300 student-answer" data-answer="pocket money"><option></option><option value="pocket money">pocket money</option><option value="compass">compass</option></select>.', reason: "Dùng \'share\' (chia sẻ) với \'pocket money\' (tiền tiêu vặt)." },
                        { q: 'My dad teaches me how to <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="do"> <select class="p-1 rounded border-gray-300 student-answer" data-answer="judo"><option></option><option value="judo">judo</option><option value="poem">poem</option></select>.', reason: "Cụm từ cố định: \'do judo\' (tập võ judo)." },
                        { q: 'We <input type="text" class="p-1 w-20 border-b-2 student-answer" data-answer="have"> a small party in our <select class="p-1 rounded border-gray-300 student-answer" data-answer="apartment"><option></option><option value="apartment">apartment</option><option value="stilt house">stilt house</option></select> tonight.', reason: "Dùng \'have a party\' (tổ chức bữa tiệc). \'Apartment\' (căn hộ) là một loại nhà." },
                    ]
                }
            ],
            part3: [
                {
                    instruction: "Điền giới từ đúng và chọn từ vựng phù hợp.",
                    example: { q: 'The new <span class="student-answer-container">sofa</span> is <span class="student-answer-container">in front of</span> the big window.', reason: "Dùng \'in front of\' (phía trước) để chỉ vị trí của sofa so với cửa sổ." },
                    questions: [
                        { q: 'I can\'t find my <select class="p-1 rounded border-gray-300 student-answer" data-answer="compass"><option></option><option value="compass">compass</option><option value="classmate">classmate</option></select>, maybe it\'s <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="under"> the book.', reason: "Dùng \'under\' (bên dưới) để chỉ vị trí bị che khuất." },
                        { q: 'My <select class="p-1 rounded border-gray-300 student-answer" data-answer="wardrobe"><option></option><option value="wardrobe">wardrobe</option><option value="apartment">apartment</option></select> is <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="between"> the bed and the <select class="p-1 rounded border-gray-300 student-answer" data-answer="chest of drawers"><option></option><option value="chest of drawers">chest of drawers</option><option value="dishwasher">dishwasher</option></select>.', reason: "Dùng \'between\' (ở giữa) khi có hai vật thể khác (cái giường và tủ kéo)." },
                        { q: 'Don\'t leave your clothes on the floor, your room is so <select class="p-1 rounded border-gray-300 student-answer" data-answer="messy"><option></option><option value="messy">messy</option><option value="smart">smart</option></select>! Put them <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="behind"> the door.', reason: "Dùng \'behind\' (phía sau) để chỉ vị trí khuất. \'Messy\' (bừa bộn) là từ phù hợp." },
                        { q: 'The <select class="p-1 rounded border-gray-300 student-answer" data-answer="microwave"><option></option><option value="microwave">microwave</option><option value="fridge">fridge</option></select> is <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="next to"> the <select class="p-1 rounded border-gray-300 student-answer" data-answer="cupboard"><option></option><option value="cupboard">cupboard</option><option value="bathroom">bathroom</option></select> in our <select class="p-1 rounded border-gray-300 student-answer" data-answer="kitchen"><option></option><option value="kitchen">kitchen</option><option value="hall">hall</option></select>.', reason: "Dùng \'next to\' (bên cạnh) để chỉ vị trí kề nhau. Các đồ vật này thuộc về \'kitchen\' (nhà bếp)." },
                        { q: 'The main <select class="p-1 rounded border-gray-300 student-answer" data-answer="hall"><option></option><option value="hall">hall</option><option value="fridge">fridge</option></select> is <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="in front of"> the school gate.', reason: "Dùng \'in front of\' (phía trước). \'Hall\' (hành lang/sảnh) là hợp lý." },
                        { q: 'My books are <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="on"> the top shelf of the <select class="p-1 rounded border-gray-300 student-answer" data-answer="cupboard"><option></option><option value="cupboard">cupboard</option><option value="sofa">sofa</option></select>.', reason: "Dùng \'on\' (trên) cho vị trí tiếp xúc bề mặt." },
                        { q: 'The <select class="p-1 rounded border-gray-300 student-answer" data-answer="bathroom"><option></option><option value="bathroom">bathroom</option><option value="kitchen">kitchen</option></select> is <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="next to"> my bedroom.', reason: "Dùng \'next to\' (bên cạnh) để chỉ hai phòng cạnh nhau." },
                        { q: 'Our house is <input type="text" class="p-1 w-24 border-b-2 student-answer" data-answer="behind"> a large <select class="p-1 rounded border-gray-300 student-answer" data-answer="department store"><option></option><option value="department store">department store</option><option value="stilt house">stilt house</option></select>.', reason: "Dùng \'behind\' (phía sau). \'Department store\' (trung tâm thương mại) là một địa điểm lớn." },
                    ]
                }
            ],
            part4: [
                {
                    instruction: "Hoàn thành câu, sắp xếp hoặc sửa lỗi sử dụng There is/are và từ vựng.",
                    example: { q: '<span class="student-answer-container">There is</span> a new <span class="student-answer-container">dishwasher</span> in the kitchen.', reason: "Dùng \'There is\' cho danh từ số ít (a new dishwasher)." },
                    questions: [
                        { q: '<input type="text" class="p-1 w-28 border-b-2 student-answer" data-answer="There are"> many trees surrounding my <select class="p-1 rounded border-gray-300 student-answer" data-answer="stilt house"><option></option><option value="stilt house">stilt house</option><option value="department store">department store</option></select>.', reason: "Dùng \'There are\' cho danh từ số nhiều (many trees)." },
                        { q: '(in / my / a / <select class="p-1 rounded border-gray-300 student-answer" data-answer="fridge"><option></option><option value="fridge">fridge</option><option value="hall">hall</option></select> / is / there / kitchen) &rarr; <input type="text" class="p-1 w-full border-b-2 student-answer" data-answer="There is a fridge in my kitchen">', reason: "Sắp xếp lại thành câu có nghĩa với cấu trúc There is + N số ít." },
                        { q: '<input type="text" class="p-1 w-28 border-b-2 student-answer" data-answer="Is there"> a <select class="p-1 rounded border-gray-300 student-answer" data-answer="greenhouse"><option></option><option value="greenhouse">greenhouse</option><option value="equipment">equipment</option></select> at your school?', reason: "Dùng \'Is there\' cho câu hỏi với danh từ số ít." },
                        { q: '<input type="text" class="p-1 w-28 border-b-2 student-answer" data-answer="Are there"> any <select class="p-1 rounded border-gray-300 student-answer" data-answer="overseas"><option></option><option value="overseas">overseas</option><option value="crazy">crazy</option></select> students in your class?', reason: "Dùng \'Are there\' cho câu hỏi với danh từ số nhiều (students)." },
                        { q: '(new / <select class="p-1 rounded border-gray-300 student-answer" data-answer="furniture"><option></option><option value="furniture">furniture</option><option value="activity">activity</option></select> / is / in / the / there / <select class="p-1 rounded border-gray-300 student-answer" data-answer="apartment"><option></option><option value="apartment">apartment</option><option value="bathroom">bathroom</option></select>) &rarr; <input type="text" class="p-1 w-full border-b-2 student-answer" data-answer="There is new furniture in the apartment">', reason: "Sắp xếp lại câu. \'Furniture\' là danh từ không đếm được nên dùng \'There is\'" },
                        { q: '<input type="text" class="p-1 w-28 border-b-2 student-answer" data-answer="There isn\'t"> a <select class="p-1 rounded border-gray-300 student-answer" data-answer="department store"><option></option><option value="department store">department store</option><option value="living room">living room</option></select> near my house.', reason: "Dạng phủ định của \'There is\' là \'There isn\'t\'" },
                        { q: 'There <span class="bg-yellow-200 p-1">is</span> a lot of <select class="p-1 rounded border-gray-300 student-answer" data-answer="crazy"><option></option><option value="crazy">crazy</option><option value="smart">smart</option></select> ideas for the new project. &rarr; <input type="text" class="p-1 w-16 border-b-2 student-answer" data-answer="are">', reason: "Sửa lỗi sai: \'a lot of ideas\' là danh từ số nhiều nên phải dùng \'are\'." },
                        { q: '<input type="text" class="p-1 w-28 border-b-2 student-answer" data-answer="Is there"> any good <select class="p-1 rounded border-gray-300 student-answer" data-answer="equipment"><option></option><option value="equipment">equipment</option><option value="furniture">furniture</option></select> in the gym?', reason: "Dùng \'Is there\' cho câu hỏi với danh từ không đếm được (equipment)." },
                    ]
                }
            ]
        };

        // --- RENDER FUNCTION --- //
        function renderExercises(part, containerId, isTeacher = false) {
            const container = document.getElementById(containerId);
            if (!container) return;

            let html = '';
            exercises[part].forEach(group => {
                html += `<h3 class="text-xl font-semibold text-gray-700 mb-4">${group.instruction}</h3>`;

                if (group.example) {
                    html += `
                    <div class="example-item">
                        <p class="text-lg text-gray-600"><strong>Ví dụ:</strong> ${group.example.q}</p>
                        <input type="text" class="reason-input bg-blue-100 border-blue-200" value="${group.example.reason}" disabled>
                    </div>`;
                }
                
                const questionsHtml = group.questions.map((item, index) => {
                    let questionContent = item.q;
                    let reasonContent = item.reason || '';

                    if (isTeacher) {
                        const tempDiv = document.createElement('div');
                        tempDiv.innerHTML = `<div>${questionContent}</div>`;
                        tempDiv.querySelectorAll('.student-answer').forEach(el => {
                            const answer = el.dataset.answer;
                            const answerWrapper = document.createElement('span');
                            answerWrapper.className = 'student-answer-container';
                            answerWrapper.textContent = answer;
                            el.replaceWith(answerWrapper);
                        });
                        questionContent = tempDiv.firstElementChild.innerHTML;
                    }

                    return `
                    <div class="question-item" data-question-id="${item.id}">
                        <p class="text-lg"><strong>Câu ${index + 1}:</strong> ${questionContent}</p>
                        <input type="text" placeholder="Lý do bạn chọn đáp án này..." class="reason-input" ${isTeacher ? `value="${reasonContent}" disabled` : ''}>
                    </div>
                `}).join('\n');

                html += `<div class="space-y-6 mt-4">${questionsHtml}</div>`;
            });
            container.innerHTML = html;
        }
        
        function renderAll(isTeacher) {
            document.body.classList.toggle('teacher-mode', isTeacher);
            renderExercises('part1', 'part1-container', isTeacher);
            renderExercises('part2', 'part2-container', isTeacher);
            renderExercises('part3', 'part3-container', isTeacher);
            renderExercises('part4', 'part4-container', isTeacher);
            document.querySelectorAll('.check-btn').forEach(btn => btn.style.display = isTeacher ? 'none' : 'inline-block');
            const submissionBlock = document.getElementById('submission-block');
            if(submissionBlock) submissionBlock.style.display = isTeacher ? 'none' : 'block';
        }

        // --- SUBMISSION LOGIC --- //
        async function handleSubmit() {
            const studentName = document.getElementById('student-name').value.trim();
            const studentClass = document.getElementById('student-class').value.trim();
            const statusEl = document.getElementById('submission-status');

            if (!studentName || !studentClass) {
                statusEl.textContent = 'Vui lòng nhập đầy đủ Họ và tên và Lớp.';
                statusEl.style.color = 'red';
                return;
            }

            statusEl.textContent = 'Đang nộp bài...';
            statusEl.style.color = 'blue';

            const allAnswers = [];
            let correctCount = 0;
            const allInputs = document.querySelectorAll('.student-answer');

            document.querySelectorAll('.question-item').forEach(item => {
                const questionId = item.dataset.questionId;
                const questionText = item.querySelector('p').innerText;
                const reason = item.querySelector('.reason-input').value;
                const answers = [];
                
                item.querySelectorAll('.student-answer').forEach(input => {
                    const isCorrect = (input.value.toLowerCase() === input.dataset.answer.toLowerCase());
                    if(isCorrect) correctCount++;
                    answers.push({ 
                        answer: input.value, 
                        correctAnswer: input.dataset.answer,
                        isCorrect
                    });
                });

                allAnswers.push({ questionId, questionText, reason, answers });
            });

            const payload = {
                studentName,
                studentClass,
                submittedAt: new Date().toISOString(),
                score: `${correctCount}/${allInputs.length}`,
                answers: allAnswers
            };

            try {
                const response = await fetch('http://localhost:3999/api/log-submission', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                if (!response.ok) {
                    throw new Error(`Lỗi từ server: ${response.statusText}`);
                }

                const result = await response.json();
                statusEl.textContent = `Nộp bài thành công! Cảm ơn bạn.`;
                statusEl.style.color = 'green';
                document.getElementById('submit-all-btn').disabled = true;

            } catch (error) {
                statusEl.textContent = `Đã có lỗi xảy ra khi nộp bài. Vui lòng thử lại. Lỗi: ${error.message}`;
                statusEl.style.color = 'red';
            }
        }


        // --- GLOBAL FUNCTION FOR TEACHER --- //
        function enableTeacherMode(password) {
            if (password === "giaoVien123") {
                localStorage.setItem('teacherMode', 'true');
                renderAll(true);
                console.log("Chế độ giáo viên đã được bật.");
            } else {
                console.error("Mật khẩu không đúng!");
            }
        }

        // --- INITIALIZATION --- //
        window.addEventListener('load', () => {
            const isTeacher = localStorage.getItem('teacherMode') === 'true';
            renderAll(isTeacher);

            if (!isTeacher) {
                document.querySelectorAll('.check-btn').forEach(button => {
                    button.addEventListener('click', (e) => {
                        const section = e.target.closest('section');
                        const inputs = section.querySelectorAll('.student-answer');
                        inputs.forEach(input => {
                            const userAnswer = (input.value || '').trim().toLowerCase();
                            const correctAnswer = (input.dataset.answer || '').trim().toLowerCase();
                            const isCorrect = (userAnswer === correctAnswer);
                            input.classList.remove('border-green-500', 'border-red-500');
                            if (input.value) { 
                                input.classList.add(isCorrect ? 'border-green-500' : 'border-red-500');
                            }
                        });
                    });
                });
                document.getElementById('submit-all-btn').addEventListener('click', handleSubmit);
            }
        });

    </script>
</body>
</html>